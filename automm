-- Load Orion UI Library
local OrionLib = loadstring(game:HttpGet(('https://raw.githubusercontent.com/jensonhirst/Orion/main/source')))()

-- Create main window
local Window = OrionLib:MakeWindow({
    Name = "Boss Farm - Captain Elephant",
    HidePremium = false,
    SaveConfig = true,
    ConfigFolder = "ElephantFarm"
})

-- Variables
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local farmEnabled = false
local fastAttackEnabled = false
local bringMobEnabled = false
local hoverEnabled = true  -- New variable for hovering above boss
local hoverHeight = 30     -- Height to hover above boss

-- Create main tab
local FarmTab = Window:MakeTab({
    Name = "Farm",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

-- Farm section
local FarmSection = FarmTab:AddSection({
    Name = "Farm Settings"
})

-- Function to equip Sharkman Karate
local function equipWeapon()
    local backpack = player.Backpack
    local weapon = backpack:FindFirstChild("Sharkman Karate")
    
    if weapon then
        character.Humanoid:EquipTool(weapon)
        return true
    else
        if character:FindFirstChild("Sharkman Karate") then
            return true
        end
        return false
    end
end

-- Tween function
local function tweenTo(destination, speed)
    if not speed then speed = 350 end
    
    local hrp = character:WaitForChild("HumanoidRootPart")
    local distance = (destination - hrp.Position).Magnitude
    local tweenService = game:GetService("TweenService")
    local info = TweenInfo.new(distance/speed, Enum.EasingStyle.Linear)
    
    local tween = tweenService:Create(hrp, info, {CFrame = CFrame.new(destination)})
    tween:Play()
    return tween
end

-- Enhanced tween function that can use CFrame directly
local function tweenToCFrame(targetCFrame, speed)
    if not speed then speed = 350 end
    
    local hrp = character:WaitForChild("HumanoidRootPart")
    local distance = (targetCFrame.Position - hrp.Position).Magnitude
    local tweenService = game:GetService("TweenService")
    local info = TweenInfo.new(distance/speed, Enum.EasingStyle.Linear)
    
    local tween = tweenService:Create(hrp, info, {CFrame = targetCFrame})
    tween:Play()
    return tween
end

-- Fast Attack function
function AttackNoCoolDown()
    local character = player.Character
    if not character then return end
    
    local equippedWeapon = nil
    for _, item in ipairs(character:GetChildren()) do
        if item:IsA("Tool") then
            equippedWeapon = item
            break
        end
    end
    
    if not equippedWeapon then return end
    
    local function IsEntityAlive(entity)
        return entity and entity:FindFirstChild("Humanoid") and entity.Humanoid.Health > 0
    end
    
    local function GetEnemiesInRange(range)
        local enemies = game:GetService("Workspace").Enemies:GetChildren()
        local targets = {}
        local playerPos = character:GetPivot().Position
        
        for _, enemy in ipairs(enemies) do
            local primaryPart = enemy:FindFirstChild("HumanoidRootPart")
            if primaryPart and IsEntityAlive(enemy) and (primaryPart.Position - playerPos).Magnitude <= range then
                table.insert(targets, enemy)
            end
        end
        
        return targets
    end
    
    if equippedWeapon:FindFirstChild("LeftClickRemote") then
        local attackCount = 1  
        local enemiesInRange = GetEnemiesInRange(60)
        
        for _, enemy in ipairs(enemiesInRange) do
            local direction = (enemy.HumanoidRootPart.Position - character:GetPivot().Position).Unit
            pcall(function()
                equippedWeapon.LeftClickRemote:FireServer(direction, attackCount)
            end)
            attackCount = attackCount + 1
            if attackCount > 1000000000 then attackCount = 1 end
        end
    else
        local targets = {}
        local enemies = game:GetService("Workspace").Enemies:GetChildren()
        local playerPos = character:GetPivot().Position
        local mainTarget = nil
        
        for _, enemy in ipairs(enemies) do
            if not enemy:GetAttribute("IsBoat") and IsEntityAlive(enemy) then
                local head = enemy:FindFirstChild("Head")
                if head and (playerPos - head.Position).Magnitude <= 60 then
                    table.insert(targets, { enemy, head })
                    mainTarget = head
                end
            end
        end
        
        if not mainTarget then return end
        
        pcall(function()
            local storage = game:GetService("ReplicatedStorage")
            local attackEvent = storage:WaitForChild("Modules"):WaitForChild("Net"):WaitForChild("RE/RegisterAttack")
            local hitEvent = storage:WaitForChild("Modules"):WaitForChild("Net"):WaitForChild("RE/RegisterHit")
            
            if #targets > 0 then
                attackEvent:FireServer(0.000000001)
                hitEvent:FireServer(mainTarget, targets)
            else
                task.wait(0.000000001)
            end
        end)
    end
end

-- Bring Mob function
local function GetMobPosition(EnemiesName)
    local pos
    local count = 0
    
    for _, v in pairs(workspace.Enemies:GetChildren()) do
        if v.Name == EnemiesName then
            if not pos then
                pos = v.HumanoidRootPart.Position
            else
                pos = pos + v.HumanoidRootPart.Position
            end
            count = count + 1
        end
    end
    
    if count > 0 then
        pos = pos / count
        return pos
    end
    return nil
end

local function TweenObject(Object, Pos, Speed)
    if Speed == nil then Speed = 350 end
    local Distance = (Pos.Position - Object.Position).Magnitude
    local tweenService = game:GetService("TweenService")
    local info = TweenInfo.new(Distance/Speed, Enum.EasingStyle.Linear)
    local tween = tweenService:Create(Object, info, {CFrame = Pos})
    tween:Play()
    return tween
end

local function BringMob()
    local ememe = game.Workspace.Enemies:GetChildren()
    if #ememe > 0 then
        local totalpos = {}
        for _, v in pairs(ememe) do
            if not totalpos[v.Name] then
                local pos = GetMobPosition(v.Name)
                if pos then
                    totalpos[v.Name] = pos
                end
            end
        end
        
        for _, v in pairs(workspace.Enemies:GetChildren()) do
            if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:FindFirstChild("HumanoidRootPart") then
                if (v.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude <= 350 then
                    for k, f in pairs(totalpos) do
                        if k and v.Name == k and f then
                            local targetCFrame = CFrame.new(f.X, f.Y, f.Z)
                            local distance = (v.HumanoidRootPart.Position - targetCFrame.Position).Magnitude
                            
                            if distance > 3 and distance <= 280 then
                                TweenObject(v.HumanoidRootPart, targetCFrame, 300)
                                v.HumanoidRootPart.CanCollide = false
                                v.Humanoid.WalkSpeed = 0
                                v.Humanoid.JumpPower = 0
                                v.Humanoid:ChangeState(14)
                                sethiddenproperty(player, "SimulationRadius", math.huge)
                            end
                        end
                    end
                end
            end
        end
    end
end

-- Function to find the boss
local function findBoss()
    -- First check if boss exists in the current workspace
    for _, v in pairs(workspace.Enemies:GetChildren()) do
        if v.Name == "Captain Elephant" and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
            return v, "workspace"
        end
    end
    
    -- If not in workspace, check in ReplicatedStorage
    local repStorage = game:GetService("ReplicatedStorage")
    local possibleLocations = {
        repStorage,
        repStorage:FindFirstChild("Enemies") or Instance.new("Folder"),
        repStorage:FindFirstChild("NPCs") or Instance.new("Folder")
    }
    
    for _, location in pairs(possibleLocations) do
        for _, v in pairs(location:GetChildren()) do
            if v.Name == "Captain Elephant" then
                return v, "replicated"
            end
        end
    end
    
    return nil
end

-- New function to position character above boss's head
local function positionAboveBoss(boss)
    if not boss or not boss:FindFirstChild("HumanoidRootPart") then return end
    
    -- Get boss position
    local bossPosition = boss.HumanoidRootPart.Position
    
    -- Create a position above the boss
    local abovePosition = Vector3.new(
        bossPosition.X, 
        bossPosition.Y + hoverHeight, 
        bossPosition.Z
    )
    
    -- Create a CFrame that faces the boss while hovering
    local lookDirection = (bossPosition - abovePosition).Unit
    local targetCFrame = CFrame.new(abovePosition, bossPosition)
    
    -- Move to position above boss
    local distance = (abovePosition - hrp.Position).Magnitude
    
    -- If already close to desired position, just set CFrame directly
    if distance < 5 then
        hrp.CFrame = targetCFrame
    else
        -- Otherwise use tween for smoother movement
        tweenToCFrame(targetCFrame, 200)
    end
    
    return distance
end

-- Main farm function with enhanced hovering
local function farmBoss()
    local hoverUpdateInterval = 0.3
    local currentTween = nil
    local isTweening = false
    local bossWasFound = false
    
    -- Hàm để hủy tween hiện tại nếu có
    local function cancelCurrentTween()
        if currentTween then
            currentTween:Cancel()
            currentTween = nil
            isTweening = false
        end
    end
    
    while farmEnabled do
        local boss, location = findBoss()
        
        -- Nếu boss đã được tìm thấy trong workspace
        if boss and location == "workspace" then
            -- Nếu đang tween đến vị trí spawn, hủy tween đó ngay lập tức
            if isTweening then
                cancelCurrentTween()
            end
            
            bossWasFound = true
            
            if boss:FindFirstChild("HumanoidRootPart") then
                -- Đảm bảo có vũ khí
                if not character:FindFirstChildOfClass("Tool") then
                    if not equipWeapon() then
                        OrionLib:MakeNotification({
                            Name = "Weapon Not Found",
                            Content = "Sharkman Karate not found in backpack",
                            Image = "rbxassetid://4483345998",
                            Time = 5
                        })
                        wait(1)
                        continue
                    end
                end
                
                -- Cập nhật vị trí tương đối với boss
                if hoverEnabled then
                    -- Lấy vị trí của boss
                    local bossPosition = boss.HumanoidRootPart.Position
                    
                    -- Tạo vị trí phía trên boss
                    local abovePosition = Vector3.new(
                        bossPosition.X, 
                        bossPosition.Y + hoverHeight, 
                        bossPosition.Z
                    )
                    
                    -- Tạo CFrame hướng xuống boss
                    local targetCFrame = CFrame.new(abovePosition, bossPosition)
                    
                    -- Kiểm tra khoảng cách
                    local distance = (abovePosition - hrp.Position).Magnitude
                    
                    -- Nếu đã ở gần, chỉ cần cập nhật CFrame
                    if distance < 5 then
                        hrp.CFrame = targetCFrame
                    else
                        -- Tween đến vị trí mới
                        hrp.CFrame = CFrame.new(hrp.Position, bossPosition) -- Hướng về phía boss ngay lập tức
                        tweenToCFrame(targetCFrame, 150)
                    end
                else
                    -- Di chuyển đến vị trí boss theo cách thông thường
                    local bossPosition = boss.HumanoidRootPart.Position
                    if (bossPosition - hrp.Position).Magnitude > 10 then
                        tweenTo(bossPosition, 150)
                    end
                end
                
                -- Thực hiện tấn công và kéo mob
                if fastAttackEnabled then
                    AttackNoCoolDown()
                end
                
                if bringMobEnabled then
                    BringMob()
                end
                
                -- Chờ thời gian ngắn trước khi lặp lại
                wait(hoverUpdateInterval)
            end
        else
            -- Nếu boss chưa được tìm thấy hoặc không còn trong workspace
            
            -- Nếu trước đó đã tìm thấy boss, đợi một chút để xác nhận boss thực sự đã biến mất
            if bossWasFound then
                wait(2)
                -- Kiểm tra lại xem boss có thực sự biến mất không
                local recheckBoss, recheckLocation = findBoss()
                if recheckBoss and recheckLocation == "workspace" then
                    continue -- Boss vẫn còn, quay lại vòng lặp chính
                end
                -- Nếu boss thực sự đã biến mất, đặt lại biến theo dõi
                bossWasFound = false
            end
            
            -- Nếu không tìm thấy boss hoặc boss ở trong ReplicatedStorage
            -- Và không đang tween đến vị trí spawn
            if not isTweening then
                local spawnPosition = Vector3.new(-13365.529296875, 321.2309875488281, -8484.990234375)
                
                -- Chỉ teleport nếu không ở gần khu vực spawn
                if (spawnPosition - hrp.Position).Magnitude > 20 then
                    OrionLib:MakeNotification({
                        Name = "Waiting for Boss",
                        Content = "Moving to Captain Elephant spawn location",
                        Image = "rbxassetid://4483345998",
                        Time = 3
                    })
                    
                    isTweening = true
                    currentTween = tweenTo(spawnPosition, 200)
                    
                    -- Đợi trong khi tween đang diễn ra, nhưng liên tục kiểm tra xem boss đã xuất hiện chưa
                    local startTime = tick()
                    local maxWaitTime = 10 -- Thời gian tối đa để đợi tween (giây)
                    
                    while isTweening and tick() - startTime < maxWaitTime and farmEnabled do
                        -- Kiểm tra lại xem boss đã xuất hiện chưa
                        local checkBoss, checkLocation = findBoss()
                        if checkBoss and checkLocation == "workspace" then
                            -- Nếu boss đã xuất hiện, hủy tween hiện tại và quay lại vòng lặp chính
                            cancelCurrentTween()
                            break
                        end
                        
                        -- Kiểm tra xem đã đến nơi chưa
                        if (spawnPosition - hrp.Position).Magnitude < 20 then
                            isTweening = false
                            break
                        }
                        
                        wait(0.5) -- Đợi một chút trước khi kiểm tra lại
                    end
                    
                    -- Nếu đã hoàn thành tween hoặc hết thời gian tối đa
                    isTweening = false
                end
            }
            
            -- Đợi một chút trước khi kiểm tra lại
            wait(1)
        end
    end
end
-- Toggle for farm
FarmTab:AddToggle({
    Name = "Farm Captain Elephant",
    Default = false,
    Callback = function(Value)
        farmEnabled = Value
        
        if Value then
            OrionLib:MakeNotification({
                Name = "Farm Enabled",
                Content = "Starting to farm Captain Elephant",
                Image = "rbxassetid://4483345998",
                Time = 5
            })
            
            task.spawn(farmBoss)
        else
            OrionLib:MakeNotification({
                Name = "Farm Disabled",
                Content = "Stopped farming Captain Elephant",
                Image = "rbxassetid://4483345998",
                Time = 5
            })
        end
    end
})

-- Toggle for fast attack
FarmTab:AddToggle({
    Name = "Fast Attack",
    Default = true,
    Callback = function(Value)
        fastAttackEnabled = Value
        
        if Value then
            OrionLib:MakeNotification({
                Name = "Fast Attack",
                Content = "Fast Attack enabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        else
            OrionLib:MakeNotification({
                Name = "Fast Attack",
                Content = "Fast Attack disabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        end
    end
})

-- Toggle for bring mob
FarmTab:AddToggle({
    Name = "Bring Mob",
    Default = true,
    Callback = function(Value)
        bringMobEnabled = Value
        
        if Value then
            OrionLib:MakeNotification({
                Name = "Bring Mob",
                Content = "Bring Mob enabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        else
            OrionLib:MakeNotification({
                Name = "Bring Mob",
                Content = "Bring Mob disabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        end
    end
})

-- New toggle for hover above boss
FarmTab:AddToggle({
    Name = "Hover Above Boss",
    Default = true,
    Callback = function(Value)
        hoverEnabled = Value
        
        if Value then
            OrionLib:MakeNotification({
                Name = "Hover Enabled",
                Content = "Will position above boss's head during farm",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        else
            OrionLib:MakeNotification({
                Name = "Hover Disabled",
                Content = "Regular positioning enabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        end
    end
})

-- Add hover height slider
FarmTab:AddSlider({
    Name = "Hover Height",
    Min = 10,
    Max = 50,
    Default = 30,
    Color = Color3.fromRGB(255, 255, 255),
    Increment = 5,
    ValueName = "units",
    Callback = function(Value)
        hoverHeight = Value
    end    
})

-- Add manual teleport button
FarmTab:AddButton({
    Name = "Teleport to Captain Elephant",
    Callback = function()
        local boss, location = findBoss()
        
        if boss and location == "workspace" and boss:FindFirstChild("HumanoidRootPart") then
            if hoverEnabled then
                -- Position above boss head
                local bossPosition = boss.HumanoidRootPart.Position
                local abovePosition = Vector3.new(
                    bossPosition.X, 
                    bossPosition.Y + hoverHeight, 
                    bossPosition.Z
                )
                tweenTo(abovePosition, 200)
            else
                -- Regular teleport
                tweenTo(boss.HumanoidRootPart.Position, 200)
            end
            
            OrionLib:MakeNotification({
                Name = "Teleporting",
                Content = "Teleporting to Captain Elephant",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        elseif location == "replicated" then
            -- Known spawn location for Captain Elephant
            local spawnPosition = Vector3.new(-13365.529296875, 321.2309875488281, -8484.990234375)
            
            tweenTo(spawnPosition, 200)
            OrionLib:MakeNotification({
                Name = "Teleporting",
                Content = "Teleporting to Captain Elephant spawn area",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        else
            OrionLib:MakeNotification({
                Name = "Boss Not Found",
                Content = "Captain Elephant not found in workspace or ReplicatedStorage",
                Image = "rbxassetid://4483345998",
                Time = 5
            })
        end
    end
})

-- Extra features tab
local SettingsTab = Window:MakeTab({
    Name = "Settings",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

-- Add attack range slider
SettingsTab:AddSlider({
    Name = "Attack Range",
    Min = 10,
    Max = 100,
    Default = 60,
    Color = Color3.fromRGB(255, 255, 255),
    Increment = 5,
    ValueName = "range",
    Callback = function(Value)
        attackRange = Value
    end    
})

-- Initialize
OrionLib:Init()

-- Clean up
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    hrp = character:WaitForChild("HumanoidRootPart")
end)

-- Notification on load
OrionLib:MakeNotification({
    Name = "Script Loaded",
    Content = "Captain Elephant Farm is ready to use",
    Image = "rbxassetid://4483345998",
    Time = 5
})
