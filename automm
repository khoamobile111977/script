-- Load Orion UI Library
local OrionLib = loadstring(game:HttpGet('https://raw.githubusercontent.com/khoamobile111977/script/refs/heads/main/orionui'))()

-- Create main window
local Window = OrionLib:MakeWindow({
    Name = "Boss Farm - Captain Elephant",
    HidePremium = false,
    SaveConfig = true,
    ConfigFolder = "ElephantFarm"
})

-- Variables
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local farmEnabled = false
local fastAttackEnabled = false
local bringMobEnabled = false
local hoverHeight = 30 -- Default hover height
local lastKnownBossPosition = nil
local noclipEnabled = false
local bossWaypoints = {
    ["Captain Elephant"] = Vector3.new(3851.01, 4.00195, -1939.11) -- Default position for Captain Elephant
}

-- Create main tab
local FarmTab = Window:MakeTab({
    Name = "Farm",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

-- Farm section
local FarmSection = FarmTab:AddSection({
    Name = "Farm Settings"
})

-- Enable NoClip function
local function setNoclip(enabled)
    noclipEnabled = enabled
    local connections = {}
    
    if enabled then
        connections.stepped = game:GetService("RunService").Stepped:Connect(function()
            if character and character:FindFirstChild("Humanoid") then
                for _, part in pairs(character:GetDescendants()) do
                    if part:IsA("BasePart") and part.CanCollide then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        for _, connection in pairs(connections) do
            if connection then connection:Disconnect() end
        end
    end
    
    return connections
end

-- Function to equip Sharkman Karate
local function equipWeapon()
    local backpack = player.Backpack
    local weapon = backpack:FindFirstChild("Sharkman Karate")
    
    if weapon then
        character.Humanoid:EquipTool(weapon)
        return true
    else
        if character:FindFirstChild("Sharkman Karate") then
            return true
        end
        return false
    end
end

-- Improved Tween function
local function tweenTo(destination, speed)
    if not speed then speed = 350 end
    
    local hrp = character:WaitForChild("HumanoidRootPart")
    local distance = (destination - hrp.Position).Magnitude
    local tweenService = game:GetService("TweenService")
    local info = TweenInfo.new(distance/speed, Enum.EasingStyle.Linear)
    
    local tween = tweenService:Create(hrp, info, {CFrame = CFrame.new(destination)})
    tween:Play()
    return tween
end

-- Fast Attack function
function AttackNoCoolDown()
    local character = player.Character
    if not character then return end
    
    local equippedWeapon = nil
    for _, item in ipairs(character:GetChildren()) do
        if item:IsA("Tool") then
            equippedWeapon = item
            break
        end
    end
    
    if not equippedWeapon then return end
    
    local function IsEntityAlive(entity)
        return entity and entity:FindFirstChild("Humanoid") and entity.Humanoid.Health > 0
    end
    
    local function GetEnemiesInRange(range)
        local enemies = game:GetService("Workspace").Enemies:GetChildren()
        local targets = {}
        local playerPos = character:GetPivot().Position
        
        for _, enemy in ipairs(enemies) do
            local primaryPart = enemy:FindFirstChild("HumanoidRootPart")
            if primaryPart and IsEntityAlive(enemy) and (primaryPart.Position - playerPos).Magnitude <= range then
                table.insert(targets, enemy)
            end
        end
        
        return targets
    end
    
    if equippedWeapon:FindFirstChild("LeftClickRemote") then
        local attackCount = 1  
        local enemiesInRange = GetEnemiesInRange(60)
        
        for _, enemy in ipairs(enemiesInRange) do
            local direction = (enemy.HumanoidRootPart.Position - character:GetPivot().Position).Unit
            pcall(function()
                equippedWeapon.LeftClickRemote:FireServer(direction, attackCount)
            end)
            attackCount = attackCount + 1
            if attackCount > 1000000000 then attackCount = 1 end
        end
    else
        local targets = {}
        local enemies = game:GetService("Workspace").Enemies:GetChildren()
        local playerPos = character:GetPivot().Position
        local mainTarget = nil
        
        for _, enemy in ipairs(enemies) do
            if not enemy:GetAttribute("IsBoat") and IsEntityAlive(enemy) then
                local head = enemy:FindFirstChild("Head")
                if head and (playerPos - head.Position).Magnitude <= 60 then
                    table.insert(targets, { enemy, head })
                    mainTarget = head
                end
            end
        end
        
        if not mainTarget then return end
        
        pcall(function()
            local storage = game:GetService("ReplicatedStorage")
            local attackEvent = storage:WaitForChild("Modules"):WaitForChild("Net"):WaitForChild("RE/RegisterAttack")
            local hitEvent = storage:WaitForChild("Modules"):WaitForChild("Net"):WaitForChild("RE/RegisterHit")
            
            if #targets > 0 then
                attackEvent:FireServer(0.000000001)
                hitEvent:FireServer(mainTarget, targets)
            else
                task.wait(0.000000001)
            end
        end)
    end
end

-- Bring Mob function
local function GetMobPosition(EnemiesName)
    local pos
    local count = 0
    
    for _, v in pairs(workspace.Enemies:GetChildren()) do
        if v.Name == EnemiesName then
            if not pos then
                pos = v.HumanoidRootPart.Position
            else
                pos = pos + v.HumanoidRootPart.Position
            end
            count = count + 1
        end
    end
    
    if count > 0 then
        pos = pos / count
        return pos
    end
    return nil
end

local function TweenObject(Object, Pos, Speed)
    if Speed == nil then Speed = 350 end
    local Distance = (Pos.Position - Object.Position).Magnitude
    local tweenService = game:GetService("TweenService")
    local info = TweenInfo.new(Distance/Speed, Enum.EasingStyle.Linear)
    local tween = tweenService:Create(Object, info, {CFrame = Pos})
    tween:Play()
    return tween
end

local function BringMob()
    local ememe = game.Workspace.Enemies:GetChildren()
    if #ememe > 0 then
        local totalpos = {}
        for _, v in pairs(ememe) do
            if not totalpos[v.Name] then
                local pos = GetMobPosition(v.Name)
                if pos then
                    totalpos[v.Name] = pos
                end
            end
        end
        
        for _, v in pairs(workspace.Enemies:GetChildren()) do
            if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:FindFirstChild("HumanoidRootPart") then
                if (v.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude <= 350 then
                    for k, f in pairs(totalpos) do
                        if k and v.Name == k and f then
                            local targetCFrame = CFrame.new(f.X, f.Y, f.Z)
                            local distance = (v.HumanoidRootPart.Position - targetCFrame.Position).Magnitude
                            
                            if distance > 3 and distance <= 280 then
                                TweenObject(v.HumanoidRootPart, targetCFrame, 300)
                                v.HumanoidRootPart.CanCollide = false
                                v.Humanoid.WalkSpeed = 0
                                v.Humanoid.JumpPower = 0
                                v.Humanoid:ChangeState(14)
                                sethiddenproperty(player, "SimulationRadius", math.huge)
                            end
                        end
                    end
                end
            end
        end
    end
end

-- Improved function to find the boss
local function findBoss()
    -- First check if the boss is already in workspace
    for _, v in pairs(workspace.Enemies:GetChildren()) do
        if v.Name == "Captain Elephant" and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
            lastKnownBossPosition = v.HumanoidRootPart.Position
            return v
        end
    end
    
    -- If not found in workspace, return nil but we'll use lastKnownBossPosition or default position
    return nil
end

-- Function to get the boss position (even if not loaded)
local function getBossPosition()
    local boss = findBoss()
    
    if boss and boss:FindFirstChild("HumanoidRootPart") then
        -- If boss is found, update the last known position and return it
        lastKnownBossPosition = boss.HumanoidRootPart.Position
        return lastKnownBossPosition
    elseif lastKnownBossPosition then
        -- If boss not found but we have a last known position, use that
        return lastKnownBossPosition
    else
        -- If all else fails, use the default waypoint
        lastKnownBossPosition = bossWaypoints["Captain Elephant"]
        return lastKnownBossPosition
    end
end

-- Function to hover above the boss
local function hoverAboveBoss()
    local bossPos = getBossPosition()
    
    if bossPos then
        -- Create a position above the boss
        local hoverPos = Vector3.new(bossPos.X, bossPos.Y + hoverHeight, bossPos.Z)
        
        -- Set character position
        if hrp then
            hrp.CFrame = CFrame.new(hoverPos)
        end
        
        return true
    end
    
    return false
end

-- Function to continuously hover
local function maintainHover()
    while farmEnabled do
        if not hoverAboveBoss() then
            -- If we failed to hover, try to move to the boss position
            local bossPos = getBossPosition()
            if bossPos then
                local hoverPos = Vector3.new(bossPos.X, bossPos.Y + hoverHeight, bossPos.Z)
                tweenTo(hoverPos, 200)
            end
        end
        
        wait(0.1)
    end
end

-- Main farm function
local function farmBoss()
    -- Enable noclip when farming
    local noclipConnections = setNoclip(true)
    
    -- Spawn a separate thread for maintaining hover
    local hoverThread = task.spawn(maintainHover)
    
    while farmEnabled do
        local bossPos = getBossPosition()
        
        if bossPos then
            -- Equip weapon if not equipped
            if not character:FindFirstChildOfClass("Tool") then
                if not equipWeapon() then
                    OrionLib:MakeNotification({
                        Name = "Weapon Not Found",
                        Content = "Sharkman Karate not found in backpack",
                        Image = "rbxassetid://4483345998",
                        Time = 5
                    })
                    wait(2)
                    continue
                end
            end
            
            -- The hover position is maintained in a separate thread
            -- Just focus on attacking and bringing mobs
            
            -- Do fast attack if enabled
            if fastAttackEnabled then
                AttackNoCoolDown()
            end
            
            -- Bring mobs if enabled
            if bringMobEnabled then
                BringMob()
            end
        else
            -- If no boss position available, wait before retrying
            wait(1)
        end
        
        wait(0.1)
    end
    
    -- Disable noclip when farming is stopped
    setNoclip(false)
    
    -- Clean up connections
    for _, connection in pairs(noclipConnections) do
        if connection then connection:Disconnect() end
    end
end

-- Toggle for farm
FarmTab:AddToggle({
    Name = "Farm Captain Elephant",
    Default = false,
    Callback = function(Value)
        farmEnabled = Value
        
        if Value then
            OrionLib:MakeNotification({
                Name = "Farm Enabled",
                Content = "Starting to farm Captain Elephant",
                Image = "rbxassetid://4483345998",
                Time = 5
            })
            
            -- First try to tween to the boss location
            local bossPos = getBossPosition()
            if bossPos then
                local hoverPos = Vector3.new(bossPos.X, bossPos.Y + hoverHeight, bossPos.Z)
                tweenTo(hoverPos, 200)
            end
            
            task.spawn(farmBoss)
        else
            OrionLib:MakeNotification({
                Name = "Farm Disabled",
                Content = "Stopped farming Captain Elephant",
                Image = "rbxassetid://4483345998",
                Time = 5
            })
        end
    end
})

-- Toggle for fast attack
FarmTab:AddToggle({
    Name = "Fast Attack",
    Default = true,
    Callback = function(Value)
        fastAttackEnabled = Value
        
        if Value then
            OrionLib:MakeNotification({
                Name = "Fast Attack",
                Content = "Fast Attack enabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        else
            OrionLib:MakeNotification({
                Name = "Fast Attack",
                Content = "Fast Attack disabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        end
    end
})

-- Toggle for bring mob
FarmTab:AddToggle({
    Name = "Bring Mob",
    Default = true,
    Callback = function(Value)
        bringMobEnabled = Value
        
        if Value then
            OrionLib:MakeNotification({
                Name = "Bring Mob",
                Content = "Bring Mob enabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        else
            OrionLib:MakeNotification({
                Name = "Bring Mob",
                Content = "Bring Mob disabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        end
    end
})

-- Toggle for noclip
FarmTab:AddToggle({
    Name = "NoClip",
    Default = false,
    Callback = function(Value)
        setNoclip(Value)
        
        if Value then
            OrionLib:MakeNotification({
                Name = "NoClip",
                Content = "NoClip enabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        else
            OrionLib:MakeNotification({
                Name = "NoClip",
                Content = "NoClip disabled",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        end
    end
})

-- Add manual teleport button
FarmTab:AddButton({
    Name = "Teleport to Captain Elephant",
    Callback = function()
        local bossPos = getBossPosition()
        
        if bossPos then
            local hoverPos = Vector3.new(bossPos.X, bossPos.Y + hoverHeight, bossPos.Z)
            tweenTo(hoverPos, 200)
            
            OrionLib:MakeNotification({
                Name = "Teleporting",
                Content = "Teleporting to Captain Elephant",
                Image = "rbxassetid://4483345998",
                Time = 3
            })
        else
            OrionLib:MakeNotification({
                Name = "Boss Location Not Found",
                Content = "Could not determine boss location",
                Image = "rbxassetid://4483345998",
                Time = 5
            })
        end
    end
})

-- Extra features tab
local SettingsTab = Window:MakeTab({
    Name = "Settings",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

-- Add hover height slider
SettingsTab:AddSlider({
    Name = "Hover Height",
    Min = 10,
    Max = 100,
    Default = 30,
    Color = Color3.fromRGB(255, 255, 255),
    Increment = 5,
    ValueName = "height",
    Callback = function(Value)
        hoverHeight = Value
    end    
})

-- Add teleport distance slider
SettingsTab:AddSlider({
    Name = "Attack Range",
    Min = 10,
    Max = 100,
    Default = 60,
    Color = Color3.fromRGB(255, 255, 255),
    Increment = 5,
    ValueName = "range",
    Callback = function(Value)
        attackRange = Value
    end    
})

-- Add custom boss position button
SettingsTab:AddButton({
    Name = "Set Current Position as Boss Location",
    Callback = function()
        lastKnownBossPosition = hrp.Position
        bossWaypoints["Captain Elephant"] = hrp.Position
        
        OrionLib:MakeNotification({
            Name = "Position Set",
            Content = "Current position saved as Captain Elephant location",
            Image = "rbxassetid://4483345998",
            Time = 3
        })
    end
})

-- Initialize
OrionLib:Init()

-- Clean up
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    hrp = character:WaitForChild("HumanoidRootPart")
end)

-- Notification on load
OrionLib:MakeNotification({
    Name = "Script Loaded",
    Content = "Captain Elephant Farm is ready to use",
    Image = "rbxassetid://4483345998",
    Time = 5
})
