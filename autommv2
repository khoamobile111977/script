local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Stats = game:GetService("Stats")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart", 9)
local Humanoid = Character:WaitForChild("Humanoid", 9)

-- Speed setting for tweening
getgenv().TweenSpeed = 350

local placeid = game.PlaceId

function WaitHRP(q0) 
    if not q0 then return end
    return q0.Character:WaitForChild("HumanoidRootPart", 9) 
end

-- Improved tweening function
function Tween(Pos)
    local character = LocalPlayer.Character
    local humanoid = character:FindFirstChild("Humanoid")
    local hrp = character:FindFirstChild("HumanoidRootPart")
    
    if humanoid and humanoid.Health > 0 and hrp then
        local distance = (Pos.Position - hrp.Position).Magnitude
        if humanoid.Sit then
            humanoid.Sit = false
        end
        
        -- Wait for any stun to wear off before tweening
        if Character:FindFirstChild("Stun") and Character.Stun.Value ~= 0 then
            repeat wait() until not Character:FindFirstChild("Stun") or Character.Stun.Value == 0
        end
        
        pcall(function()
            local tween = TweenService:Create(
                hrp,
                TweenInfo.new(distance / getgenv().TweenSpeed, Enum.EasingStyle.Linear),
                {CFrame = Pos}
            )
            tween:Play()
            if distance <= 370 then
                tween:Cancel()
                hrp.CFrame = Pos
            end
        end)
    end
end

function Taixiu(Pos)
    repeat
        wait()
        HRP.CFrame = Pos
        Humanoid:ChangeState(15)
        wait(2)
        Character.PrimaryPart.CFrame = Pos
        wait(3)
    until (Pos.Position - HRP.Position).Magnitude <= 20
end

function InstanceTween(P)
    HRP.CFrame = P
end

-- Initialize boss fighting settings
_G["DitBossDoughKing"] = false
_G["DitBossIndra"] = false
_G["L_12_34"] = true -- Enabling the hit registration system by default
NoCLip = true -- Enable noclip by default

-- Improved noclip functionality
spawn(function()
    while wait() do
        pcall(function()
            if _G["DitBossDoughKing"] or _G["DitBossIndra"] or NoCLip == true then
                if not HRP:FindFirstChild("BodyClip") then
                    local Noclip = Instance.new("BodyVelocity")
                    Noclip.Name = "BodyClip"
                    Noclip.Parent = HRP
                    Noclip.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                    Noclip.Velocity = Vector3.new(0, 0, 0)
                    for _, v in pairs(Character:GetDescendants()) do
                        if v:IsA("BasePart") then
                            v.CanCollide = false
                        end
                    end
                end
            elseif HRP:FindFirstChild("BodyClip") then
                HRP:FindFirstChild("BodyClip"):Destroy()
            end
        end)
    end
end)

local function EquipTool(toolName)
    local tool = LocalPlayer.Backpack:FindFirstChild(toolName)
    if tool and Character and Humanoid then
        task.wait(0.1)
        Humanoid:EquipTool(tool)
        return true
    end
    return false
end

local function AutoHaki()
    if not Character:FindFirstChild("HasBuso") then
        ReplicatedStorage.Remotes.CommF_:InvokeServer("Buso")
    end
end

local function CheckStun()
    local stun = Character:FindFirstChild("Stun")
    return stun and stun.Value ~= 0 or false
end

-- Weapon selection system
local ChooseWeapon = "Melee"
local SelectWeapon = nil

-- Find the best weapon in the selected category
task.spawn(function()
    while task.wait() do
        local foundWeapon = false
        for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
            if tool:IsA("Tool") and tool.ToolTip == ChooseWeapon then
                SelectWeapon = tool.Name
                foundWeapon = true
                break
            end
        end
        
        -- Check equipped tool as well
        if not foundWeapon and Character then
            for _, tool in ipairs(Character:GetChildren()) do
                if tool:IsA("Tool") and tool.ToolTip == ChooseWeapon then
                    SelectWeapon = tool.Name
                    break
                end
            end
        end
        
        -- If no weapon is found in the preferred category, try to find any weapon
        if not SelectWeapon then
            for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
                if tool:IsA("Tool") then
                    SelectWeapon = tool.Name
                    break
                end
            end
        end
    end
end)

-- Boss locations
local CongCake = CFrame.new(-2009.2802734375, 4532.97216796875, -14937.3076171875)
local AdminPos = CFrame.new(-5344.822265625, 423.98541259766, -2725.0930175781)

-- FIXED: Improved boss detection system with more frequent checks
spawn(function()
    while wait(0.5) do  -- Check more frequently
        local doughKing = nil
        local ripIndra = nil
        
        -- Find Dough King in enemies
        for _, v in pairs(Workspace.Enemies:GetChildren()) do
            if v.Name == "Dough King" and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") and v.Humanoid.Health > 0 then
                doughKing = v
                break
            end
        end
        
        -- Find Rip Indra in enemies
        for _, v in pairs(Workspace.Enemies:GetChildren()) do
            if (v.Name == "rip_indra" or v.Name == "rip_indra True Form") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") and v.Humanoid.Health > 0 then
                ripIndra = v
                break
            end
        end
        
        -- Set boss targeting priorities
        if doughKing and ripIndra then
            -- If both bosses exist, prioritize Dough King
            _G["DitBossDoughKing"] = true
            _G["DitBossIndra"] = false
            G2L["7"].Text = "Found both bosses, targeting Dough King first"
        elseif doughKing then
            _G["DitBossDoughKing"] = true
            _G["DitBossIndra"] = false
            G2L["7"].Text = "Found Dough King"
        elseif ripIndra then
            _G["DitBossDoughKing"] = false
            _G["DitBossIndra"] = true
            G2L["7"].Text = "Found Rip Indra"
        else
            _G["DitBossDoughKing"] = false
            _G["DitBossIndra"] = false
            G2L["7"].Text = "Searching for bosses..."
        end
    end
end)

-- Improved hit registration
if _G["L_12_34"] == nil then  -- Only initialize if not already set
    local L_1A, L_2B, L_3C = game:GetService("ReplicatedStorage"), game:GetService("Players"), game.Players.LocalPlayer
    local L_4D = {L_5E = true, L_6F = 0.001, L_7G = 200, L_8H = 200}
    local L_9I = L_1A:WaitForChild("Modules"):WaitForChild("Net")

    local function L_10J(L_11K)
        return L_11K and L_11K:FindFirstChild("Humanoid") and L_11K.Humanoid.Health > 0
    end

    local function L_12L()
        local L_13M = {}
        for _, L_14N in ipairs(workspace.Enemies:GetChildren()) do
            if L_10J(L_14N) then
                local L_15O = L_14N:FindFirstChild("Head") or L_14N:FindFirstChild("HumanoidRootPart")
                if L_15O and L_3C:DistanceFromCharacter(L_15O.Position) <= L_4D.L_7G then
                    table.insert(L_13M, {["Enemy"] = L_14N, ["Target"] = L_15O})
                end
            end
        end
        return L_13M
    end

    local function L_16P()
        local L_17Q, L_18R = 0, 0
        return function()
            local L_19S = tick()
            if L_19S - L_17Q >= 1 then
                L_17Q, L_18R = L_19S, 0
            end
            L_18R = L_18R + 1
            if L_18R <= L_4D.L_8H then
                return true
            else
                task.wait(0.005)
                return false
            end
        end
    end

    _G["L_12_34"] = true
    
    task.spawn(function()
        while true do
            if _G["L_12_34"] and (_G["DitBossDoughKing"] or _G["DitBossIndra"]) and L_16P()() then
                for _, L_20T in ipairs(L_12L()) do
                    pcall(function()
                        L_9I["RE/RegisterAttack"]:FireServer(0)
                        L_9I["RE/RegisterHit"]:FireServer(L_20T.Target, {{L_20T.Enemy, L_20T.Target}})
                    end)
                end
            end
            task.wait(L_4D.L_6F)
        end
    end)
end

-- FIXED: Improved Dough King boss attack function
spawn(function()
    while wait() do
        if _G["DitBossDoughKing"] then
            pcall(function()
                local dk = Workspace.Enemies:FindFirstChild("Dough King")
                if dk and dk:FindFirstChild("Humanoid") and dk:FindFirstChild("HumanoidRootPart") and dk.Humanoid.Health > 0 then
                    G2L["7"].Text = "Attacking Dough King"
                    
                    -- If there's a stun, wait until it's gone
                    if CheckStun() then
                        G2L["7"].Text = "Stunned, waiting..."
                        repeat wait() until not CheckStun()
                    end
                    
                    AutoHaki()
                    
                    -- Make sure we have a weapon equipped
                    if not Character:FindFirstChildOfClass("Tool") then
                        if not EquipTool(SelectWeapon) and LocalPlayer.Backpack:FindFirstChildOfClass("Tool") then
                            local anyTool = LocalPlayer.Backpack:FindFirstChildOfClass("Tool")
                            Humanoid:EquipTool(anyTool)
                        end
                    end
                    
                    -- Set boss properties to make it easier to hit
                    dk.HumanoidRootPart.CanCollide = false
                    dk.Humanoid.WalkSpeed = 0
                    dk.Humanoid.JumpPower = 0
                    dk.HumanoidRootPart.Size = Vector3.new(60, 60, 60) -- Larger hitbox
                    dk.HumanoidRootPart.Transparency = 0.7 -- Make it visible but semi-transparent
                    
                    -- Position above the boss to avoid some attacks
                    local targetPos = dk.HumanoidRootPart.CFrame * CFrame.new(0, 30, 0)
                    local dist = (targetPos.Position - HRP.Position).Magnitude
                    
                    if dist > 100 then
                        Tween(targetPos)
                    else
                        -- If close enough, just teleport to the target position
                        HRP.CFrame = targetPos
                    end
                    
                    -- Set simulation radius to ensure hit registration works
                    pcall(function()
                        sethiddenproperty(LocalPlayer, "SimulationRadius", math.huge)
                    end)
                else
                    G2L["7"].Text = "Searching for Dough King"
                    Tween(CongCake)
                end
            end)
        end
    end
end)

-- FIXED: Improved Rip Indra boss attack function
spawn(function()
    while wait() do
        if _G["DitBossIndra"] then
            pcall(function()
                local ripIndra = Workspace.Enemies:FindFirstChild("rip_indra True Form") or Workspace.Enemies:FindFirstChild("rip_indra")
                if ripIndra and ripIndra:FindFirstChild("Humanoid") and ripIndra:FindFirstChild("HumanoidRootPart") and ripIndra.Humanoid.Health > 0 then
                    G2L["7"].Text = "Attacking Rip Indra"
                    
                    -- If there's a stun, wait until it's gone
                    if CheckStun() then
                        G2L["7"].Text = "Stunned, waiting..."
                        repeat wait() until not CheckStun()
                    end
                    
                    AutoHaki()
                    
                    -- Make sure we have a weapon equipped
                    if not Character:FindFirstChildOfClass("Tool") then
                        if not EquipTool(SelectWeapon) and LocalPlayer.Backpack:FindFirstChildOfClass("Tool") then
                            local anyTool = LocalPlayer.Backpack:FindFirstChildOfClass("Tool")
                            Humanoid:EquipTool(anyTool)
                        end
                    end
                    
                    -- Set boss properties to make it easier to hit
                    ripIndra.HumanoidRootPart.CanCollide = false
                    ripIndra.Humanoid.WalkSpeed = 0
                    ripIndra.Humanoid.JumpPower = 0
                    ripIndra.HumanoidRootPart.Size = Vector3.new(60, 60, 60) -- Larger hitbox
                    ripIndra.HumanoidRootPart.Transparency = 0.7 -- Make it visible but semi-transparent
                    
                    -- Position above the boss to avoid some attacks
                    local targetPos = ripIndra.HumanoidRootPart.CFrame * CFrame.new(0, 30, 0)
                    local dist = (targetPos.Position - HRP.Position).Magnitude
                    
                    if dist > 100 then
                        Tween(targetPos)
                    else
                        -- If close enough, just teleport to the target position
                        HRP.CFrame = targetPos
                    end
                    
                    -- Set simulation radius to ensure hit registration works
                    pcall(function()
                        sethiddenproperty(LocalPlayer, "SimulationRadius", math.huge)
                    end)
                else
                    G2L["7"].Text = "Searching for Rip Indra"
                    Tween(AdminPos)
                end
            end)
        end
    end
end)

-- Rest of the UI code (G2L declarations) remains the same...
-- [UI Code would be here, omitted for brevity]

-- Initialize boss automatic detection
_G["DitBossDoughKing"] = false
_G["DitBossIndra"] = false
NoCLip = true
_G["L_12_34"] = true

-- Let the user know the script is running
if G2L["7"] then
    G2L["7"].Text = "Boss auto-farm initialized successfully"
end
